# Osa 03 - Model Context Protocol (MCP) -integraatio

## Johdatus MCP:hen (Model Context Protocol)

Model Context Protocol (MCP) on avoimen lähdekoodin standardi, joka yhdistää tekoälysovellukset ulkoisiin järjestelmiin. MCP:n avulla tekoälysovellukset, kuten Claude tai ChatGPT, voivat yhdistyä tietolähteisiin (esim. paikalliset tiedostot, tietokannat), työkaluihin (esim. hakukoneet, laskimet) ja työnkulkuihin (esim. erikoistuneet kehotteet), mahdollistaen pääsyn tärkeään tietoon ja tehtävien suorittamisen.

Ajattele MCP:tä kuin **USB-C-porttia tekoälysovelluksille**. Kuten USB-C tarjoaa standardoidun tavan yhdistää elektronisia laitteita, MCP tarjoaa standardoidun tavan yhdistää tekoälysovellukset ulkoisiin järjestelmiin.

### Mitä MCP mahdollistaa?

MCP avaa tekoälysovelluksille tehokkaita ominaisuuksia:

- **Henkilökohtaiset tekoälyassistentit**: Agentit voivat käyttää Google-kalenteriasi ja Notionia, toimien henkilökohtaisempana tekoälyassistenttina
- **Edistynyt koodin generointi**: Claude Code voi luoda kokonaisen verkkosovelluksen Figma-suunnitelman perusteella
- **Yrityksen tietojen integrointi**: Yrityksen chatbotit voivat yhdistyä useisiin tietokantoihin organisaation sisällä, mahdollistaen käyttäjien datan analysoinnin keskustelun avulla
- **Luovat työnkulut**: Tekoälymallit voivat luoda 3D-suunnitelmia Blenderissä ja tulostaa ne 3D-tulostimella
- **Reaaliaikainen tiedonsaanti**: Yhdistä ulkoisiin tietolähteisiin saadaksesi ajankohtaista tietoa
- **Monimutkaiset monivaiheiset operaatiot**: Suorita kehittyneitä työnkulkuja yhdistämällä useita työkaluja ja järjestelmiä

### Miksi MCP on tärkeä?

MCP tuo etuja koko ekosysteemille:

**Kehittäjille**: MCP vähentää kehitysaikaa ja monimutkaisuutta tekoälysovellusten tai agenttien rakentamisessa ja integroinnissa.

**Tekoälysovelluksille**: MCP tarjoaa pääsyn ekosysteemiin, joka sisältää tietolähteitä, työkaluja ja sovelluksia, parantaen ominaisuuksia ja loppukäyttäjän kokemusta.

**Loppukäyttäjille**: MCP mahdollistaa kyvykkäämmät tekoälysovellukset tai agentit, jotka voivat käyttää tietojasi ja toimia puolestasi tarvittaessa.

## Pienet kielimallit (SLM) MCP:ssä

Pienet kielimallit edustavat tehokasta lähestymistapaa tekoälyn käyttöönotossa ja tarjoavat useita etuja:

### SLM:n edut
- **Resurssitehokkuus**: Vähemmän laskentavaatimuksia
- **Nopeammat vasteajat**: Vähemmän viivettä reaaliaikaisissa sovelluksissa  
- **Kustannustehokkuus**: Vähäiset infrastruktuuritarpeet
- **Tietosuoja**: Voidaan ajaa paikallisesti ilman datan siirtoa
- **Mukautettavuus**: Helpompi hienosäätää tiettyihin toimialoihin

### Miksi SLM:t toimivat hyvin MCP:n kanssa

SLM:t yhdistettynä MCP:hen muodostavat tehokkaan yhdistelmän, jossa mallin päättelykykyä täydennetään ulkoisilla työkaluilla, kompensoiden pienempää parametrimäärää parannetulla toiminnallisuudella.

## Python MCP SDK:n yleiskatsaus

Python MCP SDK tarjoaa perustan MCP-yhteensopivien sovellusten rakentamiseen. SDK sisältää:

- **Asiakasohjelmakirjastot**: MCP-palvelimiin yhdistämiseen
- **Palvelinkehys**: Mukautettujen MCP-palvelimien luomiseen
- **Protokollan käsittelijät**: Viestinnän hallintaan
- **Työkalujen integrointi**: Ulkoisten toimintojen suorittamiseen

## Käytännön toteutus: Phi-4 MCP Client

Tutustutaan todelliseen toteutukseen käyttämällä Microsoftin Phi-4-minimallia, joka on integroitu MCP-ominaisuuksiin.

### MCP-arkkitehtuurin yleiskatsaus

MCP noudattaa **asiakas-palvelin-arkkitehtuuria**, jossa MCP-isäntä (tekoälysovellus, kuten Claude Code tai Claude Desktop) muodostaa yhteyksiä yhteen tai useampaan MCP-palvelimeen. MCP-isäntä tekee tämän luomalla yhden MCP-asiakkaan kutakin MCP-palvelinta varten.

#### Keskeiset osallistujat

- **MCP-isäntä**: Tekoälysovellus, joka koordinoi ja hallinnoi yhtä tai useampaa MCP-asiakasta
- **MCP-asiakas**: Komponentti, joka ylläpitää yhteyttä MCP-palvelimeen ja hankkii kontekstia MCP-palvelimelta MCP-isännän käyttöön
- **MCP-palvelin**: Ohjelma, joka tarjoaa kontekstia MCP-asiakkaille

#### Kaksikerroksinen arkkitehtuuri

MCP koostuu kahdesta erillisestä kerroksesta:

**Datalayer**: Määrittää JSON-RPC-pohjaisen protokollan asiakas-palvelin-viestintään, mukaan lukien:
- Elinkaaren hallinta (yhteyden alustus, ominaisuuksien neuvottelu)
- Perusprimitivien hallinta (työkalut, resurssit, kehotteet)
- Asiakasominaisuudet (näytteenotto, tiedonkeruu, lokitus)
- Apuominaisuudet (ilmoitukset, etenemisen seuranta)

**Kuljetuskerros**: Määrittää viestintämekanismit ja -kanavat:
- **STDIO-kuljetus**: Käyttää standardia syöttö-/tulostusvirtaa paikallisille prosesseille (optimaalinen suorituskyky, ei verkkoylikuormitusta)
- **Streamable HTTP-kuljetus**: Käyttää HTTP POST -pyyntöjä ja valinnaisia Server-Sent Events -tapahtumia etäpalvelimille (tukee standardia HTTP-todennusta)

```
┌─────────────────────────────────────┐
│           MCP Host                  │
│     (AI Application)                │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│         MCP Client 1                │
│  ┌─────────────────────────────────┐ │
│  │        Data Layer               │ │
│  │  ├── Lifecycle Management       │ │
│  │  ├── Primitives (Tools/Resources)│ │
│  │  └── Notifications              │ │
│  └─────────────────────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │      Transport Layer           │ │
│  │  ├── STDIO Transport           │ │
│  │  └── HTTP Transport            │ │
│  └─────────────────────────────────┘ │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│         MCP Server 1                │
│    (Local/Remote Context Provider)  │
└─────────────────────────────────────┘
```

### MCP:n perusprimitivit

MCP määrittää primitiivit, jotka määrittelevät, millaista kontekstuaalista tietoa tekoälysovelluksille voidaan jakaa ja mitä toimintoja voidaan suorittaa.

#### Palvelinprimitivit

MCP määrittää kolme keskeistä primitiiviä, joita palvelimet voivat tarjota:

**Työkalut**: Suoritettavat toiminnot, joita tekoälysovellukset voivat kutsua toimintojen suorittamiseksi
- Esimerkkejä: tiedosto-operaatiot, API-kutsut, tietokantakyselyt
- Menetelmät: `tools/list`, `tools/call`
- Tukee dynaamista löytämistä ja suorittamista

**Resurssit**: Tietolähteet, jotka tarjoavat kontekstuaalista tietoa tekoälysovelluksille
- Esimerkkejä: tiedostosisällöt, tietokantatiedot, API-vastaukset
- Menetelmät: `resources/list`, `resources/read`
- Mahdollistaa pääsyn jäsenneltyyn dataan

**Kehotteet**: Uudelleenkäytettävät mallit, jotka auttavat jäsentämään vuorovaikutusta kielimallien kanssa
- Esimerkkejä: järjestelmäkehotteet, muutaman esimerkin kehotteet
- Menetelmät: `prompts/list`, `prompts/get`
- Vakioi tekoälyn vuorovaikutusmallit

#### Asiakasprimitivit

MCP määrittää myös primitiivejä, joita asiakkaat voivat tarjota mahdollistamaan monipuolisemman vuorovaikutuksen:

**Näytteenotto**: Mahdollistaa palvelimien pyytää kielimallin täydentämistä asiakkaan tekoälysovelluksesta
- Menetelmä: `sampling/complete`
- Mahdollistaa mallista riippumattoman palvelimen kehittämisen
- Tarjoaa pääsyn isännän kielimalliin

**Tiedonkeruu**: Mahdollistaa palvelimien pyytää lisätietoja käyttäjiltä
- Menetelmä: `elicitation/request`
- Mahdollistaa käyttäjän vuorovaikutuksen ja vahvistuksen
- Tukee dynaamista tiedonkeruuta

**Lokitus**: Mahdollistaa palvelimien lähettää lokiviestejä asiakkaille
- Käytetään virheenkorjaukseen ja seurantaan
- Tarjoaa näkyvyyttä palvelimen toimintaan

### MCP-protokollan elinkaari

#### Alustus ja ominaisuuksien neuvottelu

MCP on tilallinen protokolla, joka vaatii elinkaaren hallintaa. Alustusprosessi palvelee useita keskeisiä tarkoituksia:

1. **Protokollaversion neuvottelu**: Varmistaa, että sekä asiakas että palvelin käyttävät yhteensopivia protokollaversioita (esim. "2025-06-18")
2. **Ominaisuuksien löytö**: Kumpikin osapuoli ilmoittaa tuetut ominaisuudet ja primitiivit
3. **Identiteettivaihto**: Tarjoaa tunnistamis- ja versiotietoja

```python
# Example initialization request
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "2025-06-18",
    "capabilities": {
      "elicitation": {},  # Client supports user interaction
      "sampling": {}      # Client can provide LLM completions
    },
    "clientInfo": {
      "name": "edge-ai-client",
      "version": "1.0.0"
    }
  }
}
```

#### Työkalujen löytäminen ja suorittaminen

Alustuksen jälkeen asiakkaat voivat löytää ja suorittaa työkaluja:

```python
# Discover available tools
tools_response = await session.list_tools()

# Execute a tool
result = await session.call_tool(
    "weather_current",
    {
        "location": "San Francisco",
        "units": "imperial"
    }
)
```

#### Reaaliaikaiset ilmoitukset

MCP tukee reaaliaikaisia ilmoituksia dynaamisia päivityksiä varten:

```python
# Server sends notification when tools change
{
  "jsonrpc": "2.0",
  "method": "notifications/tools/list_changed"
}

# Client responds by refreshing tool list
await session.list_tools()  # Get updated tools
```

## Aloittaminen: vaiheittainen opas

### Vaihe 1: Ympäristön asennus

Asenna tarvittavat riippuvuudet:
```bash
pip install fastmcp mcp-python-client openai requests pyautogui Pillow
```

### Vaihe 2: Peruskonfiguraatio

Aseta ympäristömuuttujat:
```python
# System Configuration
SYSTEM_PROMPT = "You are an AI assistant with some tools."

# Ollama Configuration (Local)
OLLAMA_URL = "http://localhost:11434/api/chat"
OLLAMA_MODEL_ID = "phi4-mini:3.8b-fp16"

# vLLM Configuration (Server)
VLLM_URL = "http://localhost:8000/v1"
VLLM_MODEL_ID = "microsoft/Phi-4-mini-instruct"
```

### Vaihe 3: Ensimmäisen MCP-asiakkaan käynnistäminen

**Perus Ollama-asennus:**
```bash
python ghmodel_mcp_demo.py
```

**vLLM-taustajärjestelmän käyttö:**
```bash
python ghmodel_mcp_demo.py --env vllm
```

**Server-Sent Events -yhteys:**
```bash
python ghmodel_mcp_demo.py --run sse
```

**Mukautettu MCP-palvelin:**
```bash
python ghmodel_mcp_demo.py --server /path/to/server.py
```

### Vaihe 4: Ohjelmallinen käyttö

```python
import asyncio
from ghmodel_mcp_demo import OllamaClient, Phi4MiniMCPClient

async def automated_interaction():
    # Configure MCP server parameters
    server_params = StdioServerParameters(
        command="npx",
        args=["@playwright/mcp@latest"],
        env=None,
    )
    
    # Create MCP client and process tools
    async with Phi4MiniMCPClient(server_params) as mcp_client:
        tools = await process_mcp_tools(mcp_client)
        llm_client = OllamaClient()
        
        # Generate response with tool capabilities
        response, messages = await llm_client.generate_response(
            "Help me automate a web task",
            tools
        )
        return response

# Execute the automation
result = asyncio.run(automated_interaction())
print(result)
```

## Edistyneet ominaisuudet

### Monitaustajärjestelmätuki

Toteutus tukee sekä Ollama- että vLLM-taustajärjestelmiä, joten voit valita tarpeidesi mukaan:

- **Ollama**: Parempi paikalliseen kehitykseen ja testaukseen
- **vLLM**: Optimoitu tuotantoon ja suurten tietomäärien käsittelyyn

### Joustavat yhteysprotokollat

Kaksi yhteystilaa ovat tuettuja:

**STDIO-tila**: Suora prosessiviestintä
- Alhaisempi viive
- Sopii paikallisille työkaluille
- Yksinkertainen asennus

**SSE-tila**: HTTP-pohjainen suoratoisto
- Verkkokykyinen
- Parempi hajautetuille järjestelmille
- Reaaliaikaiset päivitykset

### Työkalujen integrointimahdollisuudet

Järjestelmä voi integroitua erilaisiin työkaluihin:
- Verkkosivujen automaatio (Playwright)
- Tiedosto-operaatiot
- API-yhteydet
- Järjestelmäkomennot
- Mukautetut toiminnot

## Virheenkäsittely ja parhaat käytännöt

### Kattava virheiden hallinta

Toteutus sisältää vahvan virheenkäsittelyn seuraaville:

**Yhteysvirheet:**
- MCP-palvelimen toimintahäiriöt
- Verkkoyhteyden aikakatkaisut
- Yhteysongelmat

**Työkalujen suoritusvirheet:**
- Puuttuvat työkalut
- Parametrien validointi
- Suoritusvirheet

**Vastauksen käsittelyvirheet:**
- JSON-jäsennysongelmat
- Muotoilun epäjohdonmukaisuudet
- LLM-vastausten poikkeavuudet

### Parhaat käytännöt

1. **Resurssien hallinta**: Käytä asynkronisia kontekstinhallintatyökaluja
2. **Virheenkäsittely**: Toteuta kattavat try-catch-lohkot
3. **Lokitus**: Ota käyttöön sopivat lokitustasot
4. **Turvallisuus**: Vahvista syötteet ja puhdista tulosteet
5. **Suorituskyky**: Käytä yhteyspoolia ja välimuistia

## Käytännön sovellukset

### Verkkosivujen automaatio
```python
# Example: Automated web testing
async def web_automation_example():
    tools = await setup_playwright_tools()
    response = await llm_client.generate_response(
        "Navigate to example.com and take a screenshot",
        tools
    )
```

### Tiedonkäsittely
```python
# Example: File analysis
async def data_processing_example():
    tools = await setup_file_tools()
    response = await llm_client.generate_response(
        "Analyze the CSV file and generate a summary report",
        tools
    )
```

### API-integraatio
```python
# Example: API interactions
async def api_integration_example():
    tools = await setup_api_tools()
    response = await llm_client.generate_response(
        "Fetch weather data and create a forecast summary",
        tools
    )
```

## Suorituskyvyn optimointi

### Muistin hallinta
- Tehokas viestihistorian käsittely
- Asianmukainen resurssien siivous
- Yhteyspoolin käyttö

### Verkon optimointi
- Asynkroniset HTTP-toiminnot
- Konfiguroitavat aikakatkaisut
- Sulava virheiden palautus

### Samanaikainen käsittely
- Ei-blokkaava I/O
- Työkalujen rinnakkaissuoritus
- Tehokkaat asynkroniset mallit

## Turvallisuushuomiot

### Tietosuoja
- Turvallinen API-avainten hallinta
- Syötteiden validointi
- Tulosteiden puhdistus

### Verkkoturvallisuus
- HTTPS-tuki
- Paikalliset päätepisteet oletuksena
- Turvallinen tunnusten käsittely

### Suorituskyvyn turvallisuus
- Työkalujen suodatus
- Hiekkalaatikko-ympäristöt
- Auditointilokitus

## MCP-ekosysteemi ja kehitys

### MCP-projektin laajuus

Model Context Protocol -ekosysteemi sisältää useita keskeisiä komponentteja:

- **[MCP-määrittely](https://modelcontextprotocol.io/specification/latest)**: Virallinen määrittely, joka kuvaa asiakkaiden ja palvelimien toteutusvaatimukset
- **[MCP SDK:t](https://modelcontextprotocol.io/docs/sdk)**: MCP:tä toteuttavat eri ohjelmointikielten SDK:t
- **MCP-kehitystyökalut**: Työkalut MCP-palvelimien ja -asiakkaiden kehittämiseen, mukaan lukien [MCP Inspector](https://github.com/modelcontextprotocol/inspector)
- **[MCP-viitepalvelimen toteutukset](https://github.com/modelcontextprotocol/servers)**: MCP-palvelimien viitetoteutukset

### MCP-kehityksen aloittaminen

Aloittaaksesi MCP:n kanssa:

**Palvelimien rakentaminen**: [Luo MCP-palvelimia](https://modelcontextprotocol.io/docs/develop/build-server) paljastaaksesi tietosi ja työkalusi

**Asiakkaiden rakentaminen**: [Kehitä sovelluksia](https://modelcontextprotocol.io/docs/develop/build-client), jotka yhdistyvät MCP-palvelimiin

**Konseptien oppiminen**: [Ymmärrä MCP:n keskeiset käsitteet](https://modelcontextprotocol.io/docs/learn/architecture) ja arkkitehtuuri

## Yhteenveto

SLM:t integroituna MCP:hen edustavat paradigman muutosta tekoälysovellusten kehityksessä. Yhdistämällä pienten mallien tehokkuuden ulkoisten työkalujen voimaan kehittäjät voivat luoda älykkäitä järjestelmiä, jotka ovat sekä resurssitehokkaita että erittäin kyvykkäitä.

Model Context Protocol tarjoaa standardoidun tavan yhdistää tekoälysovellukset ulkoisiin järjestelmiin, aivan kuten USB-C tarjoaa universaalin liitäntästandardin elektronisille laitteille. Tämä standardointi mahdollistaa:

- **Saumattoman integraation**: Yhdistä tekoälymallit monipuolisiin tietolähteisiin ja työkaluihin
- **Ekosysteemin kasvun**: Rakenna kerran, käytä useissa tekoälysovelluksissa
- **Parannetut ominaisuudet**: Täydennä SLM:ien toiminnallisuutta ulkoisilla työkaluilla
- **Reaaliaikaiset päivitykset**: Tue dynaamisia, reagoivia tekoälysovelluksia

Keskeiset opit:
- MCP on avoin standardi, joka yhdistää tekoälysovellukset ja ulkoiset järjestelmät
- Protokolla tukee työkaluja, resursseja ja kehotteita keskeisinä primitiiveinä
- Reaaliaikaiset ilmoitukset mahdollistavat dynaamiset, reagoivat sovellukset
- Asianm
- **[Ollama Dokumentaatio](https://ollama.ai/docs)** - Paikallinen LLM-järjestelmän käyttöönottoalusta
- **[vLLM Dokumentaatio](https://docs.vllm.ai/)** - Suorituskykyinen LLM-palvelu

### Teknologiset standardit ja protokollat

- **[JSON-RPC 2.0 Määrittely](https://www.jsonrpc.org/)** - MCP:n käyttämä RPC-protokolla
- **[JSON Schema](https://json-schema.org/)** - Skeeman määrittelystandardi MCP-työkaluille
- **[OpenAPI Määrittely](https://swagger.io/specification/)** - API-dokumentaation standardi
- **[Server-Sent Events (SSE)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)** - Verkkostandardi reaaliaikaisille päivityksille

### AI-agenttien kehitys

- **[Microsoft Agent Framework](https://github.com/microsoft/agent-framework)** - Valmis ratkaisu agenttien kehittämiseen
- **[LangChain Dokumentaatio](https://docs.langchain.com/)** - Agenttien ja työkalujen integrointikehys
- **[Semantic Kernel](https://learn.microsoft.com/en-us/semantic-kernel/)** - Microsoftin AI-orkestrointiin tarkoitettu SDK

### Teollisuusraportit ja tutkimus

- **[Anthropicin Model Context Protocol -ilmoitus](https://www.anthropic.com/news/model-context-protocol)** - MCP:n alkuperäinen esittely
- **[Pienten kielimallien tutkimuskatsaus](https://arxiv.org/abs/2410.20011)** - Akateeminen katsaus SLM-tutkimukseen
- **[Edge AI -markkina-analyysi](https://www.marketsandmarkets.com/Market-Reports/edge-ai-software-market-74385617.html)** - Teollisuuden trendit ja ennusteet
- **[AI-agenttien kehityksen parhaat käytännöt](https://arxiv.org/abs/2309.02427)** - Tutkimus agenttiarkkitehtuureista

Tämä osio tarjoaa perustan omien SLM-pohjaisten MCP-sovellusten rakentamiseen, avaten mahdollisuuksia automaatioon, tiedonkäsittelyyn ja älykkäiden järjestelmien integrointiin.

## ➡️ Mitä seuraavaksi

- [Moduuli 7. Edge AI -esimerkit](../Module07/README.md)

---

**Vastuuvapauslauseke**:  
Tämä asiakirja on käännetty käyttämällä tekoälypohjaista käännöspalvelua [Co-op Translator](https://github.com/Azure/co-op-translator). Vaikka pyrimme tarkkuuteen, huomioithan, että automaattiset käännökset voivat sisältää virheitä tai epätarkkuuksia. Alkuperäinen asiakirja sen alkuperäisellä kielellä tulisi pitää ensisijaisena lähteenä. Kriittisen tiedon osalta suositellaan ammattimaista ihmiskäännöstä. Emme ole vastuussa väärinkäsityksistä tai virhetulkinnoista, jotka johtuvat tämän käännöksen käytöstä.