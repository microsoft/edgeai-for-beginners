# Скриптове за работилница

Тази директория съдържа автоматизирани и помощни скриптове, използвани за поддържане на качеството и последователността на материалите за работилницата.

## Съдържание

| Файл | Цел |
|------|-----|
| `lint_markdown_cli.py` | Проверява оградени кодови блокове в Markdown за остарели команди на Foundry Local CLI. |
| `export_benchmark_markdown.py` | Извършва тестове за латентност на множество модели и генерира отчети в Markdown + JSON формат. |

## 1. Проверка на CLI шаблони в Markdown

`lint_markdown_cli.py` сканира всички `.md` файлове, които не са преводи, за забранени шаблони на Foundry Local CLI **вътре в оградени кодови блокове** (``` ... ```). Информационният текст все още може да споменава остарели команди за исторически контекст.

### Остарели шаблони (блокирани вътре в кодови блокове)

Проверяващият блокира остарели CLI шаблони. Използвайте съвременни алтернативи.

### Задължителни замени
| Остаряло | Използвайте вместо това |
|----------|-------------------------|
| `foundry model chat <a> "..."` | `foundry model run <a> --prompt "..."` |
| `foundry model list --running` | `foundry model list` |
| `foundry model list --cached` | `foundry cache list` |
| `foundry model stats` | Скрипт за тестове + системни инструменти (`Task Manager`, `nvidia-smi`) |
| `foundry model benchmark` | `samples/session03/benchmark_oss_models.py` |
| `foundry model list --available` | `foundry model list` |

### Кодове за изход
| Код | Значение |
|-----|----------|
| 0 | Няма открити нарушения |
| 1 | Открити са една или повече остарели шаблони |

### Локално изпълнение
От кореновата директория на хранилището (препоръчително):

Windows (PowerShell):
```powershell
python Workshop\scripts\lint_markdown_cli.py --verbose
```

macOS / Linux:
```bash
python Workshop/scripts/lint_markdown_cli.py --verbose
```

### Hook за предварителен комит (по избор)
```bash
echo "python Workshop/scripts/lint_markdown_cli.py" > .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```
Това блокира комити, които въвеждат остарели шаблони.

### Интеграция с CI
GitHub Action workflow (`.github/workflows/markdown-cli-lint.yml`) изпълнява проверката при всяко качване и заявка за сливане към клоновете `main` и `Reactor`. Неуспешните задачи трябва да бъдат коригирани преди сливане.

### Добавяне на нови остарели шаблони
1. Отворете `lint_markdown_cli.py`.
2. Добавете двойка `(regex, suggestion)` към списъка `DEPRECATED`. Използвайте суров низ и включете граници на думи `\b`, където е подходящо.
3. Изпълнете проверката локално, за да потвърдите откриването.
4. Качете и изпратете; CI ще наложи новото правило.

Пример за добавяне:
```python
DEPRECATED.append((r"\\bfoundry\\s+experimental\\s+foo\\b", "Remove experimental foo usage"))
```

### Позволяване на обяснителни споменавания
Тъй като само оградените кодови блокове са обект на проверка, можете безопасно да описвате остарели команди в разказвателен текст. Ако *трябва* да ги покажете вътре в ограден блок за контраст, добавете блок **без** тройни обратни кавички (например, чрез отстъп или цитат) или пренапишете в псевдо форма.

### Пропускане на конкретни файлове (напреднали)
Ако е необходимо, поставете примери с наследени команди в отделен файл извън хранилището или преименувайте с различно разширение, докато редактирате. Умишлените пропуски за преведени копия са автоматични (пътища, съдържащи `translations`).

### Отстраняване на проблеми
| Проблем | Причина | Решение |
|---------|---------|---------|
| Проверяващият маркира ред, който сте актуализирали | Regex твърде общ | Стеснете шаблона с допълнителна граница на дума (`\b`) или котви |
| CI не успява, но локално преминава | Различна версия на Python или непотвърдени промени | Изпълнете отново локално, уверете се, че работната директория е чиста, проверете версията на Python в workflow (3.11) |
| Нужда от временно заобикаляне | Спешна корекция | Приложете корекцията веднага след това; обмислете използването на временен клон и последващ PR (избягвайте добавянето на превключватели за заобикаляне) |

### Обосновка
Поддържането на документацията в съответствие с *актуалната* стабилна CLI повърхност предотвратява затруднения в работилницата, избягва объркване на участниците и централизира измерването на производителността чрез поддържани Python скриптове вместо остарели CLI команди.

---
Поддържа се като част от инструментариума за качество на работилницата. За подобрения (например автоматично коригиране на предложения или генериране на HTML отчети), отворете проблем или изпратете PR.

## 2. Скрипт за валидиране на примери

`validate_samples.py` валидира всички Python примерни файлове за синтактична коректност, импорти и съответствие с най-добрите практики.

### Употреба
```bash
# Validate all samples
python scripts/validate_samples.py

# Validate specific session
python scripts/validate_samples.py --session 01

# Verbose mode (includes best practice warnings)
python scripts/validate_samples.py --verbose

# Summary only
python scripts/validate_samples.py --summary
```

### Какво проверява
- ✅ Валидност на Python синтаксиса
- ✅ Наличност на необходимите импорти
- ✅ Реализация на обработка на грешки (подробен режим)
- ✅ Използване на типови подсказки (подробен режим)
- ✅ Документация на функции (подробен режим)
- ✅ Препратки към SDK (подробен режим)

### Променливи на средата
- `SKIP_IMPORT_CHECK=1` - Пропускане на проверката за импорти
- `SKIP_SYNTAX_CHECK=1` - Пропускане на проверката за синтаксис

### Кодове за изход
- `0` - Всички примери преминаха валидиране
- `1` - Един или повече примери не преминаха

## 3. Скрипт за тестване на примери

`test_samples.py` изпълнява тестове на всички примери, за да провери дали се изпълняват без грешки.

### Употреба
```bash
# Test all samples
python scripts/test_samples.py

# Test specific session
python scripts/test_samples.py --session 01

# Quick mode (shorter timeouts)
python scripts/test_samples.py --quick

# Verbose mode (show output)
python scripts/test_samples.py --verbose
```

### Предпоставки
- Стартирана услуга Foundry Local: `foundry service start`
- Заредени модели: `foundry model run phi-4-mini`
- Инсталирани зависимости: `pip install -r requirements.txt`

### Какво тества
- ✅ Примерът може да се изпълни без грешки по време на изпълнение
- ✅ Генерира се необходимият изход
- ✅ Коректна обработка на грешки при неуспех
- ✅ Производителност (време за изпълнение)

### Променливи на средата
- `FOUNDRY_LOCAL_ALIAS=phi-4-mini` - Модел за тестване
- `TEST_TIMEOUT=30` - Таймаут за пример в секунди

### Очаквани неуспехи
Някои тестове може да се провалят, ако не са инсталирани допълнителни зависимости (например, `ragas`, `sentence-transformers`). Инсталирайте с:
```bash
pip install sentence-transformers ragas datasets
```

### Кодове за изход
- `0` - Всички тестове преминаха
- `1` - Един или повече тестове се провалиха

## 4. Експортер на тестове за производителност в Markdown

Скрипт: `export_benchmark_markdown.py`

Генерира възпроизводима таблица за производителност за набор от модели.

### Употреба
```powershell
python Workshop\scripts\export_benchmark_markdown.py --models "qwen2.5-0.5b" --prompt "Explain retrieval augmented generation briefly." --rounds 3 --output benchmark_report.md
```

### Изходи
| Файл | Описание |
|------|----------|
| `benchmark_report.md` | Таблица в Markdown (средно, p95, токени/сек, опционално първи токен) |
| `benchmark_report.json` | Суров масив с метрики за сравнение и история |

### Опции
| Флаг | Описание | По подразбиране |
|------|----------|-----------------|
| `--models` | Алиаси на модели, разделени със запетая | (задължително) |
| `--prompt` | Подканата, използвана за всеки рунд | (задължително) |
| `--rounds` | Рундове на модел | 3 |
| `--output` | Файл за изход в Markdown | `benchmark_report.md` |
| `--json` | Файл за изход в JSON | `benchmark_report.json` |
| `--fail-on-empty` | Нулев изход, ако всички тестове се провалят | изключено |

Променливата на средата `BENCH_STREAM=1` добавя измерване на латентността на първия токен.

### Бележки
- Използва `workshop_utils` за последователно зареждане и кеширане на модели.
- Ако се изпълнява от различна работна директория, скриптът прави опити за намиране на `workshop_utils`.
- За сравнение на GPU: изпълнете веднъж, активирайте ускорението чрез CLI конфигурация, изпълнете отново и сравнете JSON.

---

**Отказ от отговорност**:  
Този документ е преведен с помощта на AI услуга за превод [Co-op Translator](https://github.com/Azure/co-op-translator). Въпреки че се стремим към точност, моля, имайте предвид, че автоматизираните преводи може да съдържат грешки или неточности. Оригиналният документ на неговия роден език трябва да се счита за авторитетен източник. За критична информация се препоръчва професионален човешки превод. Ние не носим отговорност за каквито и да било недоразумения или погрешни интерпретации, произтичащи от използването на този превод.