# Скрипты для мастерской

Этот каталог содержит автоматизированные и вспомогательные скрипты, которые используются для поддержания качества и согласованности материалов мастерской.

## Содержание

| Файл | Назначение |
|------|-----------|
| `lint_markdown_cli.py` | Проверяет кодовые блоки в Markdown на устаревшие команды Foundry Local CLI. |
| `export_benchmark_markdown.py` | Запускает тестирование задержки для нескольких моделей и создает отчеты в формате Markdown + JSON. |

## 1. Проверка CLI шаблонов в Markdown

`lint_markdown_cli.py` сканирует все `.md` файлы, не являющиеся переводами, на наличие запрещенных шаблонов Foundry Local CLI **внутри огражденных кодовых блоков** (``` ... ```). Информационный текст все еще может упоминать устаревшие команды для исторического контекста.

### Устаревшие шаблоны (запрещены внутри кодовых блоков)

Проверка блокирует устаревшие шаблоны CLI. Используйте современные альтернативы.

### Необходимые замены
| Устаревшее | Используйте вместо |
|------------|--------------------|
| `foundry model chat <a> "..."` | `foundry model run <a> --prompt "..."` |
| `foundry model list --running` | `foundry model list` |
| `foundry model list --cached` | `foundry cache list` |
| `foundry model stats` | Скрипт тестирования + системные инструменты (`Task Manager`, `nvidia-smi`) |
| `foundry model benchmark` | `samples/session03/benchmark_oss_models.py` |
| `foundry model list --available` | `foundry model list` |

### Коды выхода
| Код | Значение |
|-----|----------|
| 0 | Нарушений не обнаружено |
| 1 | Найдены один или несколько устаревших шаблонов |

### Локальный запуск
Из корневого каталога репозитория (рекомендуется):

Windows (PowerShell):
```powershell
python Workshop\scripts\lint_markdown_cli.py --verbose
```

macOS / Linux:
```bash
python Workshop/scripts/lint_markdown_cli.py --verbose
```

### Хук перед коммитом (опционально)
```bash
echo "python Workshop/scripts/lint_markdown_cli.py" > .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```
Блокирует коммиты, которые вводят устаревшие шаблоны.

### Интеграция с CI
GitHub Action workflow (`.github/workflows/markdown-cli-lint.yml`) запускает проверку при каждом пуше и pull request в ветки `main` и `Reactor`. Ошибки необходимо исправить перед слиянием.

### Добавление новых устаревших шаблонов
1. Откройте `lint_markdown_cli.py`.
2. Добавьте кортеж `(regex, suggestion)` в список `DEPRECATED`. Используйте raw-строку и включите границы слов `\b`, где это необходимо.
3. Запустите проверку локально, чтобы убедиться в обнаружении.
4. Закоммитьте и отправьте изменения; CI будет применять новое правило.

Пример добавления:
```python
DEPRECATED.append((r"\\bfoundry\\s+experimental\\s+foo\\b", "Remove experimental foo usage"))
```

### Разрешение упоминаний для пояснения
Поскольку проверка применяется только к огражденным кодовым блокам, вы можете безопасно описывать устаревшие команды в повествовательном тексте. Если вам *необходимо* показать их внутри блока, используйте блок без тройных обратных кавычек (например, отступ или цитирование) или перепишите в псевдоформе.

### Пропуск определенных файлов (расширенные настройки)
При необходимости, поместите примеры с устаревшими командами в отдельный файл вне репозитория или переименуйте с другим расширением при подготовке. Пропуски для переведенных копий выполняются автоматически (пути, содержащие `translations`).

### Устранение неполадок
| Проблема | Причина | Решение |
|----------|---------|---------|
| Проверка отмечает строку, которую вы обновили | Слишком широкий шаблон | Уточните шаблон, добавив дополнительные границы слов (`\b`) или якоря |
| CI не проходит, но локально все работает | Различие в версиях Python или незакоммиченные изменения | Перезапустите локально, убедитесь, что рабочее дерево чистое, проверьте версию Python в workflow (3.11) |
| Нужно временно обойти проверку | Срочный хотфикс | Примените исправление сразу после; рассмотрите использование временной ветки и последующего PR (избегайте добавления обходных переключателей) |

### Обоснование
Поддержание документации в соответствии с *текущей* стабильной поверхностью CLI предотвращает трудности на мастерской, избегает путаницы у участников и централизует измерение производительности через поддерживаемые Python-скрипты вместо устаревших CLI-команд.

---
Поддерживается как часть инструментария для обеспечения качества мастерской. Для улучшений (например, автоматическое исправление предложений или генерация HTML-отчетов) откройте задачу или отправьте PR.

## 2. Скрипт проверки примеров

`validate_samples.py` проверяет все файлы с примерами на Python на синтаксис, импорты и соответствие лучшим практикам.

### Использование
```bash
# Validate all samples
python scripts/validate_samples.py

# Validate specific session
python scripts/validate_samples.py --session 01

# Verbose mode (includes best practice warnings)
python scripts/validate_samples.py --verbose

# Summary only
python scripts/validate_samples.py --summary
```

### Что проверяется
- ✅ Корректность синтаксиса Python
- ✅ Наличие необходимых импортов
- ✅ Реализация обработки ошибок (расширенный режим)
- ✅ Использование аннотаций типов (расширенный режим)
- ✅ Наличие строк документации функций (расширенный режим)
- ✅ Ссылки на SDK (расширенный режим)

### Переменные окружения
- `SKIP_IMPORT_CHECK=1` - Пропустить проверку импортов
- `SKIP_SYNTAX_CHECK=1` - Пропустить проверку синтаксиса

### Коды выхода
- `0` - Все примеры прошли проверку
- `1` - Один или несколько примеров не прошли проверку

## 3. Тестирование примеров

`test_samples.py` запускает тесты на всех примерах, чтобы убедиться, что они выполняются без ошибок.

### Использование
```bash
# Test all samples
python scripts/test_samples.py

# Test specific session
python scripts/test_samples.py --session 01

# Quick mode (shorter timeouts)
python scripts/test_samples.py --quick

# Verbose mode (show output)
python scripts/test_samples.py --verbose
```

### Предварительные условия
- Запущен сервис Foundry Local: `foundry service start`
- Загружены модели: `foundry model run phi-4-mini`
- Установлены зависимости: `pip install -r requirements.txt`

### Что тестируется
- ✅ Пример выполняется без ошибок времени выполнения
- ✅ Генерируется необходимый вывод
- ✅ Корректная обработка ошибок при сбое
- ✅ Производительность (время выполнения)

### Переменные окружения
- `FOUNDRY_LOCAL_ALIAS=phi-4-mini` - Модель для тестирования
- `TEST_TIMEOUT=30` - Тайм-аут на пример в секундах

### Ожидаемые сбои
Некоторые тесты могут завершиться неудачно, если не установлены дополнительные зависимости (например, `ragas`, `sentence-transformers`). Установите их с помощью:
```bash
pip install sentence-transformers ragas datasets
```

### Коды выхода
- `0` - Все тесты прошли успешно
- `1` - Один или несколько тестов завершились неудачно

## 4. Экспорт результатов тестирования в Markdown

Скрипт: `export_benchmark_markdown.py`

Генерирует воспроизводимую таблицу производительности для набора моделей.

### Использование
```powershell
python Workshop\scripts\export_benchmark_markdown.py --models "qwen2.5-0.5b" --prompt "Explain retrieval augmented generation briefly." --rounds 3 --output benchmark_report.md
```

### Выводы
| Файл | Описание |
|------|----------|
| `benchmark_report.md` | Таблица в формате Markdown (среднее, p95, токены/сек, опционально первый токен) |
| `benchmark_report.json` | Массив метрик для сравнения и истории |

### Опции
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `--models` | Список алиасов моделей через запятую | (обязательно) |
| `--prompt` | Запрос, используемый в каждом раунде | (обязательно) |
| `--rounds` | Количество раундов на модель | 3 |
| `--output` | Файл вывода в формате Markdown | `benchmark_report.md` |
| `--json` | Файл вывода в формате JSON | `benchmark_report.json` |
| `--fail-on-empty` | Ненулевой код выхода, если все тесты завершились неудачно | выключено |

Переменная окружения `BENCH_STREAM=1` добавляет измерение задержки первого токена.

### Примечания
- Использует `workshop_utils` для согласованной загрузки моделей и кэширования.
- Если скрипт запускается из другого рабочего каталога, он пытается найти `workshop_utils` через резервные пути.
- Для сравнения GPU: выполните один раз, включите ускорение через настройки CLI, выполните повторно и сравните JSON.

---

**Отказ от ответственности**:  
Этот документ был переведен с использованием сервиса автоматического перевода [Co-op Translator](https://github.com/Azure/co-op-translator). Хотя мы стремимся к точности, пожалуйста, учитывайте, что автоматические переводы могут содержать ошибки или неточности. Оригинальный документ на его родном языке следует считать авторитетным источником. Для получения критически важной информации рекомендуется профессиональный перевод человеком. Мы не несем ответственности за любые недоразумения или неправильные интерпретации, возникающие в результате использования данного перевода.